<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LIMIT KEEPER</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a1a">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #262626;
            --bg-tertiary: #333333;
            --accent: #F58220;
            --accent-hover: #FF9A40;
            --text-primary: #FFFFFF;
            --text-secondary: #CCCCCC;
            --text-muted: #888888;
            --border-color: #404040;
            --danger: #DC2626;
            --success: #10B981;
            --warning: #F59E0B;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Header - Mobile Optimized */
        .header {
            background: var(--bg-primary);
            border-bottom: 2px solid var(--accent);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 16px;
            font-weight: 900;
            letter-spacing: 1px;
        }

        .logo-accent {
            color: var(--accent);
        }

        .header-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 2px;
            padding: 10px;
            cursor: pointer;
            color: var(--text-primary);
            -webkit-tap-highlight-color: transparent;
        }

        .header-btn:active {
            background: var(--accent);
        }

        .header-btn svg {
            width: 20px;
            height: 20px;
            display: block;
        }

        /* Tab Navigation - Horizontal Scroll */
        .tab-nav {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }

        .tab-nav::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 12px 16px;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
            white-space: nowrap;
            cursor: pointer;
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            background: var(--bg-secondary);
        }

        /* Main Container - Full Width Mobile */
        .container {
            max-width: 100%;
            padding: 12px;
        }

        @media (min-width: 480px) {
            .container {
                max-width: 480px;
                margin: 0 auto;
                padding: 16px;
            }
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Balance Hero - Compact Mobile */
        .balance-hero {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--accent);
            padding: 20px 16px;
            margin-bottom: 12px;
            text-align: center;
        }

        .balance-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .balance-amount {
            font-size: 42px;
            font-weight: 900;
            color: var(--accent);
            letter-spacing: -1px;
            line-height: 1;
            margin-bottom: 12px;
        }

        @media (min-width: 400px) {
            .balance-amount {
                font-size: 52px;
            }
        }

        .balance-amount.warning {
            color: var(--warning);
        }

        .balance-amount.danger {
            color: var(--danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* Progress Bar */
        .progress-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--warning) 50%, var(--danger) 100%);
            background-size: 200% 100%;
            transition: width 0.3s;
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-muted);
        }

        /* Stats Grid - 2x2 Mobile */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 12px 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 9px;
            color: var(--text-muted);
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 14px;
            font-weight: 700;
        }

        @media (min-width: 400px) {
            .stat-value {
                font-size: 16px;
            }
        }

        .stat-value.accent {
            color: var(--accent);
        }

        .stat-value.success {
            color: var(--success);
        }

        .stat-value.warning {
            color: var(--warning);
        }

        .stat-value.danger {
            color: var(--danger);
        }

        /* Budget Pace Section */
        .budget-pace-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 16px;
            margin-bottom: 12px;
        }

        .budget-pace-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 12px;
            text-align: center;
        }

        .pace-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .pace-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: 14px 12px;
            text-align: center;
            position: relative;
        }

        .pace-card.highlight {
            border-color: var(--accent);
            background: rgba(245, 130, 32, 0.1);
        }

        .pace-label {
            font-size: 10px;
            color: var(--text-muted);
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .pace-amount {
            font-size: 22px;
            font-weight: 900;
            color: var(--accent);
            margin-bottom: 4px;
        }

        @media (min-width: 400px) {
            .pace-amount {
                font-size: 26px;
            }
        }

        .pace-sub {
            font-size: 10px;
            color: var(--text-secondary);
        }

        .pace-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 2px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            margin-top: 6px;
        }

        .pace-status.ok {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .pace-status.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .pace-status.danger {
            background: rgba(220, 38, 38, 0.2);
            color: var(--danger);
        }

        /* Pie Chart Section */
        .chart-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 16px;
            margin-bottom: 12px;
        }

        .chart-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 12px;
            text-align: center;
        }

        .chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        @media (min-width: 400px) {
            .chart-container {
                flex-direction: row;
                justify-content: center;
            }
        }

        .pie-chart {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            position: relative;
            flex-shrink: 0;
        }

        .pie-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70px;
            height: 70px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .pie-center-label {
            font-size: 8px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .pie-center-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .legend-amount {
            font-weight: 600;
            color: var(--text-primary);
        }

        .no-chart-data {
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
            padding: 20px;
        }

        /* Quick Amount Buttons - Mobile Grid */
        .quick-amounts {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }

        .quick-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 2px;
            padding: 12px 6px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .quick-btn:active {
            background: var(--accent);
            color: var(--text-primary);
        }

        /* Input Section - Mobile Optimized */
        .input-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 16px 12px;
            margin-bottom: 12px;
        }

        .input-section h2 {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            font-size: 10px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 14px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 2px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            font-weight: 600;
            -webkit-appearance: none;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
        }

        select {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23F58220'%3E%3Cpath d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        /* Pay Button - Large Touch Target */
        .pay-btn {
            width: 100%;
            padding: 16px;
            background: var(--accent);
            border: none;
            border-radius: 2px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
        }

        .pay-btn:active {
            background: var(--accent-hover);
        }

        /* Undo Button */
        .undo-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 2px;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .undo-btn:disabled {
            opacity: 0.3;
        }

        .undo-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Category Cards - Compact */
        .category-summary-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 14px 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .category-summary-card:active {
            border-color: var(--accent);
        }

        .category-summary-name {
            font-size: 13px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-summary-name::before {
            content: '▶';
            color: var(--accent);
            font-size: 8px;
        }

        .category-summary-spent {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
        }

        /* History Section */
        .history-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 16px 12px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .history-header h2 {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .clear-history-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 2px;
            padding: 6px 10px;
            color: var(--text-muted);
            font-size: 10px;
            cursor: pointer;
        }

        .history-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-date {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .history-category {
            background: var(--accent);
            padding: 2px 6px;
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            border-radius: 2px;
        }

        .history-amount {
            font-size: 14px;
            font-weight: 700;
        }

        .empty-history {
            text-align: center;
            color: var(--text-muted);
            padding: 30px 16px;
            font-size: 13px;
        }

        /* Category Tab Balance */
        .balance-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--accent);
            padding: 20px 16px;
            margin-bottom: 12px;
        }

        .category-balance-amount {
            font-size: 36px;
            font-weight: 900;
            color: var(--accent);
        }

        .category-budget-info {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Modal - Full Screen Mobile */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 200;
            padding: 0;
        }

        .modal-overlay.active {
            display: block;
        }

        .modal {
            background: var(--bg-primary);
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }

        @media (min-width: 480px) {
            .modal-overlay.active {
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }

            .modal {
                max-width: 400px;
                height: auto;
                max-height: 85vh;
                border: 1px solid var(--border-color);
            }
        }

        .modal-header {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--accent);
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
        }

        .modal-header h2 {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 28px;
            cursor: pointer;
            padding: 4px 8px;
        }

        .modal-body {
            padding: 16px;
        }

        .modal-section {
            margin-bottom: 24px;
        }

        .modal-section:last-child {
            margin-bottom: 0;
        }

        .modal-section h3 {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .btn-primary {
            background: var(--accent);
            border: none;
            border-radius: 2px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-danger {
            background: var(--danger);
            border: none;
            border-radius: 2px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }

        .budget-form {
            display: flex;
            gap: 8px;
        }

        .budget-form input {
            flex: 1;
        }

        .category-add-form {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .category-add-form input {
            flex: 1;
        }

        .category-list {
            max-height: 180px;
            overflow-y: auto;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            margin-bottom: 6px;
        }

        .category-name {
            font-size: 13px;
            font-weight: 600;
        }

        .category-delete-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 6px;
            cursor: pointer;
        }

        .category-delete-btn svg {
            width: 16px;
            height: 16px;
        }

        .empty-categories {
            text-align: center;
            color: var(--text-muted);
            padding: 16px;
            font-size: 12px;
        }

        .data-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 2px;
            padding: 12px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Daily Warning */
        .daily-limit-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            padding: 10px 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--warning);
        }

        .daily-limit-warning.danger {
            background: rgba(220, 38, 38, 0.1);
            border-color: var(--danger);
            color: var(--danger);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-tertiary);
            border: 1px solid var(--accent);
            padding: 12px 20px;
            font-size: 13px;
            font-weight: 600;
            z-index: 300;
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Ticker */
        .ticker-bar {
            background: var(--accent);
            padding: 6px 0;
            overflow: hidden;
            white-space: nowrap;
        }

        .ticker-content {
            display: inline-block;
            animation: ticker 15s linear infinite;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        @keyframes ticker {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-50%);
            }
        }

        .no-categories-msg {
            text-align: center;
            color: var(--text-muted);
            padding: 24px 16px;
            font-size: 13px;
        }

        .no-categories-msg button {
            margin-top: 12px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }
    </style>
</head>

<body>
    <!-- Ticker -->
    <div class="ticker-bar">
        <div class="ticker-content" id="tickerContent">
            ● LIMIT KEEPER ● 残高をリアルタイムで追跡 ● LIMIT KEEPER ● 残高をリアルタイムで追跡 ●
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="logo"><span class="logo-accent">▶</span> LIMIT <span class="logo-accent">KEEPER</span></div>
        <button class="header-btn" onclick="openSettings()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3" />
                <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z" />
            </svg>
        </button>
    </header>

    <!-- Tab Navigation -->
    <nav class="tab-nav" id="tabNav">
        <button class="tab-btn active" data-tab="home" onclick="switchTab('home')">◆ ホーム</button>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <div class="tab-content active" id="tab-home">
            <div class="daily-limit-warning" id="dailyWarning" style="display: none;">
                <span>⚠️</span>
                <span id="dailyWarningText"></span>
            </div>

            <!-- Balance Hero -->
            <div class="balance-hero">
                <div class="balance-label">使える残高</div>
                <div class="balance-amount" id="mainBalanceDisplay">¥0</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-labels">
                    <span>0%</span>
                    <span id="usagePercent">0%使用</span>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">予算</div>
                    <div class="stat-value accent" id="statBudget">¥0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">使用済</div>
                    <div class="stat-value" id="statSpent">¥0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">今日の支出</div>
                    <div class="stat-value" id="statToday">¥0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">残り日数</div>
                    <div class="stat-value" id="statDaysLeft">30日</div>
                </div>
            </div>

            <!-- Budget Pace -->
            <div class="budget-pace-section" id="budgetPaceSection">
                <div class="budget-pace-title">使える金額の目安</div>
                <div class="pace-grid">
                    <div class="pace-card highlight">
                        <div class="pace-label">1日あたり</div>
                        <div class="pace-amount" id="paceDaily">¥0</div>
                        <div class="pace-sub">今日の残り</div>
                        <div class="pace-status ok" id="paceDailyStatus">OK</div>
                    </div>
                    <div class="pace-card">
                        <div class="pace-label">1週間あたり</div>
                        <div class="pace-amount" id="paceWeekly">¥0</div>
                        <div class="pace-sub">今週の残り</div>
                        <div class="pace-status ok" id="paceWeeklyStatus">OK</div>
                    </div>
                </div>
            </div>

            <!-- Pie Chart -->
            <div class="chart-section" id="chartSection">
                <div class="chart-title">カテゴリ別支出</div>
                <div class="chart-container" id="chartContainer">
                    <div class="no-chart-data">支出データがありません</div>
                </div>
            </div>

            <!-- Input -->
            <div class="input-section">
                <h2>支出を入力</h2>
                <div class="quick-amounts">
                    <button class="quick-btn" onclick="quickPay(100)">¥100</button>
                    <button class="quick-btn" onclick="quickPay(500)">¥500</button>
                    <button class="quick-btn" onclick="quickPay(1000)">¥1K</button>
                    <button class="quick-btn" onclick="quickPay(5000)">¥5K</button>
                </div>
                <div class="input-group">
                    <label>金額</label>
                    <input type="number" id="homeAmountInput" placeholder="0" min="0" inputmode="numeric">
                </div>
                <div class="input-group">
                    <label>カテゴリ</label>
                    <select id="homeCategorySelect">
                        <option value="">-- 未分類 --</option>
                    </select>
                </div>
                <button class="pay-btn" onclick="homeRecordExpense()">▶ PAY</button>
                <button class="undo-btn" id="undoBtn" onclick="undoLastExpense()" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 10h10a5 5 0 0 1 0 10H9" />
                        <polyline points="3,10 7,6" />
                        <polyline points="3,10 7,14" />
                    </svg>
                    取消
                </button>
            </div>

            <!-- Category Cards -->
            <div id="categorySummaryList"></div>

            <!-- History -->
            <div class="history-section">
                <div class="history-header">
                    <h2>最近の履歴</h2>
                    <button class="clear-history-btn" onclick="clearAllHistory()">クリア</button>
                </div>
                <div class="history-list" id="homeHistoryList">
                    <div class="empty-history">履歴がありません</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>設定</h2>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-section">
                    <h3>予算設定</h3>
                    <div class="budget-form">
                        <input type="number" id="budgetInput" placeholder="予算額" min="0" inputmode="numeric">
                        <button class="btn-primary" onclick="setBudget()">設定</button>
                    </div>
                </div>
                <div class="modal-section">
                    <h3>カテゴリ管理</h3>
                    <div class="category-add-form">
                        <input type="text" id="newCategoryInput" placeholder="カテゴリ名">
                        <button class="btn-primary" onclick="addCategory()">追加</button>
                    </div>
                    <div class="category-list" id="categoryList">
                        <div class="empty-categories">カテゴリがありません</div>
                    </div>
                </div>
                <div class="modal-section">
                    <h3>データ管理</h3>
                    <div class="data-actions">
                        <button class="btn-secondary" onclick="exportData()">エクスポート</button>
                        <button class="btn-secondary"
                            onclick="document.getElementById('importFile').click()">インポート</button>
                        <input type="file" id="importFile" accept=".json" style="display:none"
                            onchange="importData(event)">
                    </div>
                    <button class="btn-danger" onclick="resetAll()">全データリセット</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const COLORS = ['#F58220', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899', '#F59E0B', '#6366F1', '#14B8A6'];

        let state = { budget: 0, balance: 0, spent: 0, history: [], categories: [] };
        let currentTab = 'home';

        function init() {
            loadState();
            renderAll();
            updateTicker();
        }

        function loadState() {
            const saved = localStorage.getItem('limitKeeperState');
            if (saved) state = JSON.parse(saved);
        }

        function saveState() {
            localStorage.setItem('limitKeeperState', JSON.stringify(state));
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        function updateTicker() {
            const t = document.getElementById('tickerContent');
            const b = state.balance >= 0 ? `残高 ¥${state.balance.toLocaleString()}` : `超過 ¥${Math.abs(state.balance).toLocaleString()}`;
            t.innerHTML = `●  ${b}  ●  LIMIT KEEPER  ●  ${b}  ●  LIMIT KEEPER  ●`;
        }

        function renderAll() {
            renderTabs();
            renderHomeTab();
            renderPieChart();
            renderCategoryTabs();
            renderCategoryList();
            renderHomeCategorySelect();
            updateUndoButton();
            updateTicker();
        }

        function renderTabs() {
            const nav = document.getElementById('tabNav');
            nav.innerHTML = `<button class="tab-btn ${currentTab === 'home' ? 'active' : ''}" data-tab="home" onclick="switchTab('home')">◆ ホーム</button>`;
            state.categories.forEach(cat => {
                nav.innerHTML += `<button class="tab-btn ${currentTab === cat ? 'active' : ''}" data-tab="${cat}" onclick="switchTab('${cat}')">${cat}</button>`;
            });
        }

        function renderHomeCategorySelect() {
            const sel = document.getElementById('homeCategorySelect');
            sel.innerHTML = '<option value="">-- 未分類 --</option>';
            state.categories.forEach(cat => sel.innerHTML += `<option value="${cat}">${cat}</option>`);
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.tab === tab);
            });
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const target = document.getElementById('tab-' + tab);
            if (target) target.classList.add('active');
        }

        function getTodaySpending() {
            const today = new Date().toDateString();
            return state.history.filter(h => new Date(h.timestamp).toDateString() === today).reduce((s, h) => s + h.amount, 0);
        }

        function getCategorySpending() {
            const data = {};
            state.history.forEach(h => {
                const cat = h.category || '未分類';
                data[cat] = (data[cat] || 0) + h.amount;
            });
            return Object.entries(data).map(([name, amount]) => ({ name, amount })).sort((a, b) => b.amount - a.amount);
        }

        function renderPieChart() {
            const container = document.getElementById('chartContainer');
            const spending = getCategorySpending();
            const total = spending.reduce((s, c) => s + c.amount, 0);

            if (total === 0) {
                container.innerHTML = '<div class="no-chart-data">支出データがありません</div>';
                return;
            }

            // Create conic gradient
            let gradient = '';
            let currentAngle = 0;
            spending.forEach((cat, i) => {
                const percent = (cat.amount / total) * 100;
                const color = COLORS[i % COLORS.length];
                gradient += `${color} ${currentAngle}deg ${currentAngle + (percent * 3.6)}deg, `;
                currentAngle += percent * 3.6;
            });
            gradient = gradient.slice(0, -2);

            // Legend
            const legend = spending.map((cat, i) => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${COLORS[i % COLORS.length]}"></div>
                    <span>${cat.name}</span>
                    <span class="legend-amount">¥${cat.amount.toLocaleString()}</span>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="pie-chart" style="background: conic-gradient(${gradient})">
                    <div class="pie-center">
                        <div class="pie-center-label">合計</div>
                        <div class="pie-center-value">¥${total.toLocaleString()}</div>
                    </div>
                </div>
                <div class="chart-legend">${legend}</div>
            `;
        }

        function getWeekSpending() {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - dayOfWeek);
            startOfWeek.setHours(0, 0, 0, 0);
            return state.history.filter(h => new Date(h.timestamp) >= startOfWeek).reduce((s, h) => s + h.amount, 0);
        }

        function renderHomeTab() {
            const bal = document.getElementById('mainBalanceDisplay');
            bal.textContent = '¥' + state.balance.toLocaleString();
            bal.classList.remove('warning', 'danger');
            if (state.balance < 0) bal.classList.add('danger');
            else if (state.budget > 0 && state.balance < state.budget * 0.2) bal.classList.add('warning');

            document.getElementById('statBudget').textContent = '¥' + state.budget.toLocaleString();
            document.getElementById('statSpent').textContent = '¥' + state.spent.toLocaleString();
            document.getElementById('statToday').textContent = '¥' + getTodaySpending().toLocaleString();

            const pct = state.budget > 0 ? Math.min((state.spent / state.budget) * 100, 100) : 0;
            document.getElementById('progressFill').style.width = pct + '%';
            document.getElementById('usagePercent').textContent = Math.round(pct) + '%使用';

            // Budget Pace Calculation
            const todaySpent = getTodaySpending();
            const weekSpent = getWeekSpending();

            if (state.budget > 0 && state.balance > 0) {
                // Calculate remaining days in month (assuming 30-day budget period)
                const daysRemaining = Math.max(1, Math.ceil(state.balance / (state.budget / 30)));
                document.getElementById('statDaysLeft').textContent = daysRemaining + '日';

                // Daily pace: remaining balance / remaining days
                const dailyBudget = Math.floor(state.balance / daysRemaining);
                const dailyRemaining = Math.max(0, dailyBudget - todaySpent);
                document.getElementById('paceDaily').textContent = '¥' + dailyRemaining.toLocaleString();

                // Update daily status
                const dailyStatus = document.getElementById('paceDailyStatus');
                if (todaySpent > dailyBudget * 1.5) {
                    dailyStatus.textContent = '超過！';
                    dailyStatus.className = 'pace-status danger';
                } else if (todaySpent > dailyBudget) {
                    dailyStatus.textContent = '注意';
                    dailyStatus.className = 'pace-status warning';
                } else {
                    dailyStatus.textContent = 'OK';
                    dailyStatus.className = 'pace-status ok';
                }

                // Weekly pace: daily * 7
                const weeklyBudget = dailyBudget * 7;
                const weeklyRemaining = Math.max(0, weeklyBudget - weekSpent);
                document.getElementById('paceWeekly').textContent = '¥' + weeklyRemaining.toLocaleString();

                // Update weekly status
                const weeklyStatus = document.getElementById('paceWeeklyStatus');
                if (weekSpent > weeklyBudget * 1.2) {
                    weeklyStatus.textContent = '超過！';
                    weeklyStatus.className = 'pace-status danger';
                } else if (weekSpent > weeklyBudget * 0.8) {
                    weeklyStatus.textContent = '注意';
                    weeklyStatus.className = 'pace-status warning';
                } else {
                    weeklyStatus.textContent = 'OK';
                    weeklyStatus.className = 'pace-status ok';
                }

                document.getElementById('budgetPaceSection').style.display = 'block';
            } else if (state.budget > 0) {
                document.getElementById('statDaysLeft').textContent = '0日';
                document.getElementById('paceDaily').textContent = '¥0';
                document.getElementById('paceWeekly').textContent = '¥0';
                document.getElementById('paceDailyStatus').textContent = '超過！';
                document.getElementById('paceDailyStatus').className = 'pace-status danger';
                document.getElementById('paceWeeklyStatus').textContent = '超過！';
                document.getElementById('paceWeeklyStatus').className = 'pace-status danger';
                document.getElementById('budgetPaceSection').style.display = 'block';
            } else {
                document.getElementById('statDaysLeft').textContent = '--';
                document.getElementById('budgetPaceSection').style.display = 'none';
            }

            // Warning
            const warn = document.getElementById('dailyWarning');
            if (state.budget > 0) {
                const daily = state.budget / 30;
                if (todaySpent > daily * 1.5) {
                    warn.style.display = 'flex';
                    warn.classList.add('danger');
                    document.getElementById('dailyWarningText').textContent = `今日: ¥${todaySpent.toLocaleString()} / 1日平均: ¥${Math.round(daily).toLocaleString()}`;
                } else if (todaySpent > daily) {
                    warn.style.display = 'flex';
                    warn.classList.remove('danger');
                    document.getElementById('dailyWarningText').textContent = `今日の支出が1日平均を超えています`;
                } else {
                    warn.style.display = 'none';
                }
            } else {
                warn.style.display = 'none';
            }

            // Category cards
            const list = document.getElementById('categorySummaryList');
            if (state.categories.length === 0) {
                list.innerHTML = `<div class="no-categories-msg">カテゴリを追加しましょう<br><button class="btn-primary" onclick="openSettings()">設定</button></div>`;
            } else {
                list.innerHTML = state.categories.map(cat => {
                    const spent = state.history.filter(h => h.category === cat).reduce((s, h) => s + h.amount, 0);
                    return `<div class="category-summary-card" onclick="switchTab('${cat}')">
                        <span class="category-summary-name">${cat}</span>
                        <span class="category-summary-spent">¥${spent.toLocaleString()}</span>
                    </div>`;
                }).join('');
            }

            // History
            const hist = document.getElementById('homeHistoryList');
            if (state.history.length === 0) {
                hist.innerHTML = '<div class="empty-history">履歴がありません</div>';
            } else {
                hist.innerHTML = state.history.slice(-5).reverse().map(h => `
                    <div class="history-item">
                        <div class="history-info">
                            <span class="history-date">${h.date}</span>
                            <span class="history-category">${h.category || '未分類'}</span>
                        </div>
                        <span class="history-amount">-¥${h.amount.toLocaleString()}</span>
                    </div>
                `).join('');
            }
        }

        function renderCategoryTabs() {
            const container = document.querySelector('.container');
            document.querySelectorAll('.tab-content:not(#tab-home)').forEach(el => el.remove());

            state.categories.forEach(cat => {
                const spent = state.history.filter(h => h.category === cat).reduce((s, h) => s + h.amount, 0);
                const hist = state.history.filter(h => h.category === cat);

                const div = document.createElement('div');
                div.className = 'tab-content' + (currentTab === cat ? ' active' : '');
                div.id = 'tab-' + cat;
                div.innerHTML = `
                    <div class="balance-section">
                        <div class="balance-label">${cat} 使用額</div>
                        <div class="category-balance-amount">¥${spent.toLocaleString()}</div>
                        <div class="category-budget-info">${hist.length}件の支出</div>
                    </div>
                    <div class="input-section">
                        <h2>${cat}に追加</h2>
                        <div class="quick-amounts">
                            <button class="quick-btn" onclick="categoryQuickPay('${cat}', 100)">¥100</button>
                            <button class="quick-btn" onclick="categoryQuickPay('${cat}', 500)">¥500</button>
                            <button class="quick-btn" onclick="categoryQuickPay('${cat}', 1000)">¥1K</button>
                            <button class="quick-btn" onclick="categoryQuickPay('${cat}', 5000)">¥5K</button>
                        </div>
                        <div class="input-group">
                            <label>金額</label>
                            <input type="number" id="amount-${cat}" placeholder="0" min="0" inputmode="numeric">
                        </div>
                        <button class="pay-btn" onclick="recordExpense('${cat}')">▶ PAY</button>
                    </div>
                    <div class="history-section">
                        <div class="history-header">
                            <h2>履歴</h2>
                            <button class="clear-history-btn" onclick="clearCategoryHistory('${cat}')">クリア</button>
                        </div>
                        <div class="history-list">
                            ${hist.length === 0 ? '<div class="empty-history">履歴がありません</div>' :
                        hist.slice().reverse().map(h => `
                                    <div class="history-item">
                                        <div class="history-info"><span class="history-date">${h.date}</span></div>
                                        <span class="history-amount">-¥${h.amount.toLocaleString()}</span>
                                    </div>
                                `).join('')
                    }
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            state.categories.forEach(cat => {
                const input = document.getElementById('amount-' + cat);
                if (input) input.addEventListener('keypress', e => { if (e.key === 'Enter') recordExpense(cat); });
            });
        }

        function renderCategoryList() {
            const list = document.getElementById('categoryList');
            if (state.categories.length === 0) {
                list.innerHTML = '<div class="empty-categories">カテゴリがありません</div>';
            } else {
                list.innerHTML = state.categories.map(cat => `
                    <div class="category-item">
                        <span class="category-name">${cat}</span>
                        <button class="category-delete-btn" onclick="deleteCategory('${cat}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                        </button>
                    </div>
                `).join('');
            }
        }

        function updateUndoButton() {
            document.getElementById('undoBtn').disabled = state.history.length === 0;
        }

        function quickPay(amount) {
            const cat = document.getElementById('homeCategorySelect').value;
            recordExpenseWithAmount(amount, cat);
        }

        function categoryQuickPay(cat, amount) {
            recordExpenseWithAmount(amount, cat);
        }

        function homeRecordExpense() {
            const amount = parseInt(document.getElementById('homeAmountInput').value) || 0;
            const cat = document.getElementById('homeCategorySelect').value;
            if (amount <= 0) { showToast('金額を入力'); return; }
            recordExpenseWithAmount(amount, cat);
            document.getElementById('homeAmountInput').value = '';
        }

        function recordExpenseWithAmount(amount, category) {
            const now = new Date();
            const date = `${now.getMonth() + 1}/${now.getDate()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            state.history.push({ date, category, amount, timestamp: now.toISOString() });
            state.spent += amount;
            state.balance = state.budget - state.spent;
            saveState();
            renderAll();
            showToast(`¥${amount.toLocaleString()} 記録`);
        }

        function recordExpense(cat) {
            const input = document.getElementById('amount-' + cat);
            const amount = parseInt(input.value) || 0;
            if (amount <= 0) { showToast('金額を入力'); return; }
            recordExpenseWithAmount(amount, cat);
            input.value = '';
        }

        function undoLastExpense() {
            if (state.history.length === 0) return;
            const last = state.history.pop();
            state.spent -= last.amount;
            state.balance = state.budget - state.spent;
            saveState();
            renderAll();
            showToast(`¥${last.amount.toLocaleString()} 取消`);
        }

        function setBudget() {
            const budget = parseInt(document.getElementById('budgetInput').value) || 0;
            if (budget <= 0) { showToast('予算を入力'); return; }
            state.budget = budget;
            state.balance = budget - state.spent;
            saveState();
            renderAll();
            document.getElementById('budgetInput').value = '';
            closeSettings();
            showToast(`予算 ¥${budget.toLocaleString()}`);
        }

        function addCategory() {
            const name = document.getElementById('newCategoryInput').value.trim();
            if (!name) { showToast('カテゴリ名を入力'); return; }
            if (state.categories.includes(name)) { showToast('既に存在します'); return; }
            state.categories.push(name);
            saveState();
            renderAll();
            document.getElementById('newCategoryInput').value = '';
            showToast(`「${name}」追加`);
        }

        function deleteCategory(name) {
            if (!confirm(`「${name}」を削除？`)) return;
            state.categories = state.categories.filter(c => c !== name);
            if (currentTab === name) currentTab = 'home';
            saveState();
            renderAll();
            showToast('削除しました');
        }

        function clearCategoryHistory(cat) {
            if (!confirm(`「${cat}」の履歴を削除？`)) return;
            const removed = state.history.filter(h => h.category === cat).reduce((s, h) => s + h.amount, 0);
            state.history = state.history.filter(h => h.category !== cat);
            state.spent -= removed;
            state.balance = state.budget - state.spent;
            saveState();
            renderAll();
            showToast('クリア');
        }

        function clearAllHistory() {
            if (!confirm('全履歴を削除？')) return;
            state.history = [];
            state.spent = 0;
            state.balance = state.budget;
            saveState();
            renderAll();
            showToast('全クリア');
        }

        function resetAll() {
            if (!confirm('全データをリセット？')) return;
            state = { budget: 0, balance: 0, spent: 0, history: [], categories: [] };
            currentTab = 'home';
            saveState();
            renderAll();
            closeSettings();
            showToast('リセット完了');
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `limit-keeper-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showToast('エクスポート完了');
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (ev) {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (data.budget !== undefined && data.history !== undefined) {
                        state = data;
                        saveState();
                        renderAll();
                        showToast('インポート完了');
                    } else {
                        showToast('無効なファイル');
                    }
                } catch { showToast('読み込み失敗'); }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        function openSettings() { document.getElementById('settingsModal').classList.add('active'); }
        function closeSettings() { document.getElementById('settingsModal').classList.remove('active'); }

        document.getElementById('settingsModal').addEventListener('click', function (e) { if (e.target === this) closeSettings(); });
        document.getElementById('homeAmountInput').addEventListener('keypress', e => { if (e.key === 'Enter') homeRecordExpense(); });
        document.getElementById('budgetInput').addEventListener('keypress', e => { if (e.key === 'Enter') setBudget(); });
        document.getElementById('newCategoryInput').addEventListener('keypress', e => { if (e.key === 'Enter') addCategory(); });

        init();
    </script>
</body>

</html>