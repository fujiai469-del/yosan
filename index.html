<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIMIT KEEPER</title>
    <link rel="manifest"
        href="data:application/json,{&quot;name&quot;:&quot;Limit Keeper&quot;,&quot;short_name&quot;:&quot;Limit&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%231a1a1a&quot;,&quot;theme_color&quot;:&quot;%23F58220&quot;}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #262626;
            --bg-tertiary: #333333;
            --accent: #F58220;
            --accent-hover: #FF9A40;
            --text-primary: #FFFFFF;
            --text-secondary: #CCCCCC;
            --text-muted: #888888;
            --border-color: #404040;
            --danger: #DC2626;
            --success: #10B981;
            --warning: #F59E0B;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Roboto', Arial, sans-serif;
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        /* Header */
        .header {
            background: var(--bg-primary);
            border-bottom: 2px solid var(--accent);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 20px;
            font-weight: 900;
            letter-spacing: 2px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-accent {
            color: var(--accent);
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 2px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .header-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
        }

        .header-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Tab Navigation */
        .tab-nav {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .tab-nav::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 14px 20px;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--text-secondary);
            background: var(--bg-secondary);
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            background: var(--bg-secondary);
        }

        /* Main Container */
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Main Balance Display */
        .balance-hero {
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0d0d0d 100%);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--accent);
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .balance-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(245, 130, 32, 0.1) 0%, transparent 60%);
            pointer-events: none;
        }

        .balance-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .balance-amount {
            font-size: 56px;
            font-weight: 900;
            color: var(--accent);
            letter-spacing: -2px;
            margin-bottom: 16px;
            text-shadow: 0 0 40px rgba(245, 130, 32, 0.3);
            transition: color 0.3s;
        }

        .balance-amount.warning {
            color: var(--warning);
        }

        .balance-amount.danger {
            color: var(--danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* Progress Bar */
        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--warning) 50%, var(--danger) 100%);
            background-size: 200% 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 16px 12px;
            text-align: center;
        }

        .stat-label {
            font-size: 9px;
            color: var(--text-muted);
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-value.accent {
            color: var(--accent);
        }

        /* Quick Amount Buttons */
        .quick-amounts {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .quick-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 2px;
            padding: 12px 8px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--text-primary);
        }

        /* Category Summary Cards */
        .category-summary-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 16px 20px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-summary-card:hover {
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        .category-summary-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-summary-name::before {
            content: '▶';
            color: var(--accent);
            font-size: 10px;
        }

        .category-summary-spent {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
        }

        /* Balance Display for Category */
        .balance-section {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--accent);
            padding: 24px;
            margin-bottom: 20px;
        }

        .category-balance-amount {
            font-size: 42px;
            font-weight: 900;
            color: var(--accent);
            letter-spacing: -2px;
        }

        .category-budget-info {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Input Section */
        .input-section {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 20px;
        }

        .input-section h2 {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 16px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 2px;
            color: var(--text-primary);
            font-size: 18px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            transition: border-color 0.2s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
        }

        input[type="number"]::placeholder,
        input[type="text"]::placeholder {
            color: var(--text-muted);
            font-weight: 400;
        }

        /* Pay Button */
        .pay-btn {
            width: 100%;
            padding: 18px;
            background: var(--accent);
            border: none;
            border-radius: 2px;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 3px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pay-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .pay-btn:active {
            transform: translateY(0);
        }

        /* Undo Button */
        .undo-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 2px;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .undo-btn:hover {
            border-color: var(--warning);
            color: var(--warning);
        }

        .undo-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* History Section */
        .history-section {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 20px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .history-header h2 {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .clear-history-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 2px;
            padding: 6px 12px;
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-history-btn:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .history-date {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .history-category {
            background: var(--accent);
            color: var(--text-primary);
            padding: 3px 8px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            border-radius: 2px;
        }

        .history-amount {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .empty-history {
            text-align: center;
            color: var(--text-muted);
            padding: 40px 20px;
            font-size: 14px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 200;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--accent);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--accent);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-section {
            margin-bottom: 24px;
        }

        .modal-section:last-child {
            margin-bottom: 0;
        }

        .modal-section h3 {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .btn-primary {
            background: var(--accent);
            border: none;
            border-radius: 2px;
            padding: 12px 20px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 1px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-danger {
            background: var(--danger);
            border: none;
            border-radius: 2px;
            padding: 12px 20px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 1px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-danger:hover {
            background: #EF4444;
        }

        .budget-form {
            display: flex;
            gap: 10px;
        }

        .budget-form input {
            flex: 1;
        }

        /* Category Management */
        .category-add-form {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .category-add-form input {
            flex: 1;
        }

        .category-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            margin-bottom: 8px;
        }

        .category-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .category-delete-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            transition: color 0.2s;
        }

        .category-delete-btn:hover {
            color: var(--danger);
        }

        .category-delete-btn svg {
            width: 16px;
            height: 16px;
        }

        .empty-categories {
            text-align: center;
            color: var(--text-muted);
            padding: 20px;
            font-size: 13px;
        }

        /* Daily Limit Warning */
        .daily-limit-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--warning);
        }

        .daily-limit-warning.danger {
            background: rgba(220, 38, 38, 0.1);
            border-color: var(--danger);
            color: var(--danger);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Live Ticker Effect */
        .ticker-bar {
            background: var(--accent);
            padding: 8px 0;
            overflow: hidden;
            white-space: nowrap;
        }

        .ticker-content {
            display: inline-block;
            animation: ticker 20s linear infinite;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        @keyframes ticker {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-50%);
            }
        }

        .no-categories-msg {
            text-align: center;
            color: var(--text-muted);
            padding: 40px 20px;
            font-size: 14px;
        }

        .no-categories-msg button {
            margin-top: 16px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-tertiary);
            border: 1px solid var(--accent);
            padding: 14px 24px;
            border-radius: 2px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            z-index: 300;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Export/Import Section */
        .data-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 16px;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 2px;
            padding: 12px 16px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
    </style>
</head>

<body>
    <!-- Ticker Bar -->
    <div class="ticker-bar">
        <div class="ticker-content" id="tickerContent">
            ● LIMIT KEEPER — 減算式予算管理システム ● 支出を記録し、残高をリアルタイムで追跡 ● LIMIT KEEPER — 減算式予算管理システム ● 支出を記録し、残高をリアルタイムで追跡 ●
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="logo">
            <span class="logo-accent">▶</span> LIMIT <span class="logo-accent">KEEPER</span>
        </div>
        <div class="header-actions">
            <button class="header-btn" onclick="openSettings()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3" />
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z" />
                </svg>
            </button>
        </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="tab-nav" id="tabNav">
        <button class="tab-btn active" data-tab="home" onclick="switchTab('home')">◆ ホーム</button>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <!-- Home Tab Content -->
        <div class="tab-content active" id="tab-home">
            <!-- Daily Limit Warning (if applicable) -->
            <div class="daily-limit-warning" id="dailyWarning" style="display: none;">
                <span>⚠️</span>
                <span id="dailyWarningText"></span>
            </div>

            <!-- Main Balance Hero -->
            <div class="balance-hero">
                <div class="balance-label">使える残高 / Available</div>
                <div class="balance-amount" id="mainBalanceDisplay">¥0</div>

                <!-- Progress Bar -->
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-labels">
                        <span>0%使用</span>
                        <span id="usagePercent">0%使用</span>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">予算</div>
                    <div class="stat-value accent" id="statBudget">¥0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">使用済</div>
                    <div class="stat-value" id="statSpent">¥0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">今日</div>
                    <div class="stat-value" id="statToday">¥0</div>
                </div>
            </div>

            <!-- Quick Input -->
            <div class="input-section">
                <h2>クイック入力</h2>
                <div class="quick-amounts">
                    <button class="quick-btn" onclick="quickPay(100)">¥100</button>
                    <button class="quick-btn" onclick="quickPay(500)">¥500</button>
                    <button class="quick-btn" onclick="quickPay(1000)">¥1K</button>
                    <button class="quick-btn" onclick="quickPay(5000)">¥5K</button>
                </div>
                <div class="input-group">
                    <label>金額を入力</label>
                    <input type="number" id="homeAmountInput" placeholder="0" min="0">
                </div>
                <div class="input-group">
                    <label>カテゴリ</label>
                    <select id="homeCategorySelect" style="padding-right: 40px;">
                        <option value="">-- 未分類 --</option>
                    </select>
                </div>
                <button class="pay-btn" onclick="homeRecordExpense()">▶ PAY</button>
                <button class="undo-btn" id="undoBtn" onclick="undoLastExpense()" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 10h10a5 5 0 0 1 0 10H9" />
                        <polyline points="3,10 7,6" />
                        <polyline points="3,10 7,14" />
                    </svg>
                    最後の入力を取消
                </button>
            </div>

            <!-- Category Summary Cards -->
            <div class="category-summary-list" id="categorySummaryList"></div>

            <!-- Recent History -->
            <div class="history-section">
                <div class="history-header">
                    <h2>最近の履歴</h2>
                    <button class="clear-history-btn" onclick="clearAllHistory()">全クリア</button>
                </div>
                <div class="history-list" id="homeHistoryList">
                    <div class="empty-history">履歴がありません</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>設定 / Settings</h2>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Budget Setting -->
                <div class="modal-section">
                    <h3>予算設定 / Budget</h3>
                    <div class="budget-form">
                        <input type="number" id="budgetInput" placeholder="予算額を入力" min="0">
                        <button class="btn-primary" onclick="setBudget()">設定</button>
                    </div>
                </div>

                <!-- Category Management -->
                <div class="modal-section">
                    <h3>カテゴリ管理 / Categories</h3>
                    <div class="category-add-form">
                        <input type="text" id="newCategoryInput" placeholder="新しいカテゴリ名">
                        <button class="btn-primary" onclick="addCategory()">追加</button>
                    </div>
                    <div class="category-list" id="categoryList">
                        <div class="empty-categories">カテゴリがありません</div>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="modal-section">
                    <h3>データ管理</h3>
                    <div class="data-actions">
                        <button class="btn-secondary" onclick="exportData()">エクスポート</button>
                        <button class="btn-secondary"
                            onclick="document.getElementById('importFile').click()">インポート</button>
                        <input type="file" id="importFile" accept=".json" style="display:none"
                            onchange="importData(event)">
                    </div>
                    <div style="margin-top: 16px;">
                        <button class="btn-danger" onclick="resetAll()">全データリセット</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // State
        let state = {
            budget: 0,
            balance: 0,
            spent: 0,
            history: [],
            categories: []
        };

        let currentTab = 'home';
        let lastExpense = null;

        // Initialize
        function init() {
            loadState();
            renderAll();
            updateTicker();
        }

        // Load state from localStorage
        function loadState() {
            const savedState = localStorage.getItem('limitKeeperState');
            if (savedState) {
                state = JSON.parse(savedState);
            }
        }

        // Save state to localStorage
        function saveState() {
            localStorage.setItem('limitKeeperState', JSON.stringify(state));
        }

        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // Update ticker with current balance
        function updateTicker() {
            const ticker = document.getElementById('tickerContent');
            const balanceText = state.balance >= 0 ? `残高 ¥${state.balance.toLocaleString()}` : `超過 ¥${Math.abs(state.balance).toLocaleString()}`;
            ticker.innerHTML = `●  ${balanceText}  ●  LIMIT KEEPER  ●  ${balanceText}  ●  LIMIT KEEPER  ●  ${balanceText}  ●  LIMIT KEEPER  ●`;
        }

        // Render all components
        function renderAll() {
            renderTabs();
            renderHomeTab();
            renderCategoryTabs();
            renderCategoryList();
            renderHomeCategorySelect();
            updateUndoButton();
            updateTicker();
        }

        // Render tab navigation
        function renderTabs() {
            const tabNav = document.getElementById('tabNav');
            tabNav.innerHTML = '<button class="tab-btn ' + (currentTab === 'home' ? 'active' : '') + '" data-tab="home" onclick="switchTab(\'home\')">◆ ホーム</button>';

            state.categories.forEach(cat => {
                const isActive = currentTab === cat ? 'active' : '';
                tabNav.innerHTML += `<button class="tab-btn ${isActive}" data-tab="${cat}" onclick="switchTab('${cat}')">${cat}</button>`;
            });
        }

        // Render home category select
        function renderHomeCategorySelect() {
            const select = document.getElementById('homeCategorySelect');
            select.innerHTML = '<option value="">-- 未分類 --</option>';
            state.categories.forEach(cat => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }

        // Switch tab
        function switchTab(tabName) {
            currentTab = tabName;

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) btn.classList.add('active');
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            const targetTab = document.getElementById('tab-' + tabName);
            if (targetTab) targetTab.classList.add('active');
        }

        // Calculate today's spending
        function getTodaySpending() {
            const today = new Date().toDateString();
            return state.history
                .filter(h => new Date(h.timestamp).toDateString() === today)
                .reduce((sum, h) => sum + h.amount, 0);
        }

        // Render home tab
        function renderHomeTab() {
            // Main balance display
            const balanceEl = document.getElementById('mainBalanceDisplay');
            balanceEl.textContent = '¥' + state.balance.toLocaleString();

            // Balance color based on status
            balanceEl.classList.remove('warning', 'danger');
            if (state.balance < 0) {
                balanceEl.classList.add('danger');
            } else if (state.budget > 0 && state.balance < state.budget * 0.2) {
                balanceEl.classList.add('warning');
            }

            // Stats
            document.getElementById('statBudget').textContent = '¥' + state.budget.toLocaleString();
            document.getElementById('statSpent').textContent = '¥' + state.spent.toLocaleString();
            document.getElementById('statToday').textContent = '¥' + getTodaySpending().toLocaleString();

            // Progress bar
            const usagePercent = state.budget > 0 ? Math.min((state.spent / state.budget) * 100, 100) : 0;
            document.getElementById('progressFill').style.width = usagePercent + '%';
            document.getElementById('usagePercent').textContent = Math.round(usagePercent) + '%使用';

            // Daily warning
            const dailyWarning = document.getElementById('dailyWarning');
            const todaySpent = getTodaySpending();
            if (state.budget > 0) {
                const dailyBudget = state.budget / 30;
                if (todaySpent > dailyBudget * 1.5) {
                    dailyWarning.style.display = 'flex';
                    dailyWarning.classList.add('danger');
                    dailyWarning.classList.remove('warning');
                    document.getElementById('dailyWarningText').textContent = `今日の支出が1日平均の150%を超えています！（¥${todaySpent.toLocaleString()} / ¥${Math.round(dailyBudget).toLocaleString()}）`;
                } else if (todaySpent > dailyBudget) {
                    dailyWarning.style.display = 'flex';
                    dailyWarning.classList.remove('danger');
                    document.getElementById('dailyWarningText').textContent = `今日の支出が1日平均を超えています（¥${todaySpent.toLocaleString()} / ¥${Math.round(dailyBudget).toLocaleString()}）`;
                } else {
                    dailyWarning.style.display = 'none';
                }
            } else {
                dailyWarning.style.display = 'none';
            }

            // Category summary cards
            const summaryList = document.getElementById('categorySummaryList');
            if (state.categories.length === 0) {
                summaryList.innerHTML = `
                    <div class="no-categories-msg">
                        カテゴリを追加して支出を管理しましょう
                        <br><button class="btn-primary" onclick="openSettings()">設定を開く</button>
                    </div>
                `;
            } else {
                let html = '';
                state.categories.forEach(cat => {
                    const catSpent = state.history
                        .filter(h => h.category === cat)
                        .reduce((sum, h) => sum + h.amount, 0);

                    html += `
                        <div class="category-summary-card" onclick="switchTab('${cat}')">
                            <span class="category-summary-name">${cat}</span>
                            <span class="category-summary-spent">¥${catSpent.toLocaleString()}</span>
                        </div>
                    `;
                });
                summaryList.innerHTML = html;
            }

            // Recent history (last 5)
            const historyList = document.getElementById('homeHistoryList');
            if (state.history.length === 0) {
                historyList.innerHTML = '<div class="empty-history">履歴がありません</div>';
            } else {
                historyList.innerHTML = state.history.slice(-5).reverse().map(item => `
                    <div class="history-item">
                        <div class="history-info">
                            <span class="history-date">${item.date}</span>
                            <span class="history-category">${item.category || '未分類'}</span>
                        </div>
                        <span class="history-amount">-¥${item.amount.toLocaleString()}</span>
                    </div>
                `).join('');
            }
        }

        // Render category tabs content
        function renderCategoryTabs() {
            const container = document.querySelector('.container');
            document.querySelectorAll('.tab-content:not(#tab-home)').forEach(el => el.remove());

            state.categories.forEach(cat => {
                const catSpent = state.history
                    .filter(h => h.category === cat)
                    .reduce((sum, h) => sum + h.amount, 0);

                const catHistory = state.history.filter(h => h.category === cat);

                const tabContent = document.createElement('div');
                tabContent.className = 'tab-content' + (currentTab === cat ? ' active' : '');
                tabContent.id = 'tab-' + cat;

                tabContent.innerHTML = `
                    <div class="balance-section">
                        <div class="balance-label">${cat} 支出合計</div>
                        <div class="category-balance-amount">¥${catSpent.toLocaleString()}</div>
                        <div class="category-budget-info">
                            このカテゴリでの支出: ${catHistory.length}件
                        </div>
                    </div>

                    <div class="input-section">
                        <h2>${cat}の支出を入力</h2>
                        <div class="quick-amounts">
                            <button class="quick-btn" onclick="categoryQuickPay('${cat}', 100)">¥100</button>
                            <button class="quick-btn" onclick="categoryQuickPay('${cat}', 500)">¥500</button>
                            <button class="quick-btn" onclick="categoryQuickPay('${cat}', 1000)">¥1K</button>
                            <button class="quick-btn" onclick="categoryQuickPay('${cat}', 5000)">¥5K</button>
                        </div>
                        <div class="input-group">
                            <label>金額 (Amount)</label>
                            <input type="number" id="amount-${cat}" placeholder="0" min="0">
                        </div>
                        <button class="pay-btn" onclick="recordExpense('${cat}')">▶ PAY</button>
                    </div>

                    <div class="history-section">
                        <div class="history-header">
                            <h2>${cat}の履歴</h2>
                            <button class="clear-history-btn" onclick="clearCategoryHistory('${cat}')">クリア</button>
                        </div>
                        <div class="history-list">
                            ${catHistory.length === 0 ?
                        '<div class="empty-history">履歴がありません</div>' :
                        catHistory.slice().reverse().map(item => `
                                    <div class="history-item">
                                        <div class="history-info">
                                            <span class="history-date">${item.date}</span>
                                        </div>
                                        <span class="history-amount">-¥${item.amount.toLocaleString()}</span>
                                    </div>
                                `).join('')
                    }
                        </div>
                    </div>
                `;

                container.appendChild(tabContent);
            });

            // Add enter key support
            state.categories.forEach(cat => {
                const input = document.getElementById('amount-' + cat);
                if (input) input.addEventListener('keypress', e => { if (e.key === 'Enter') recordExpense(cat); });
            });
        }

        // Render category list in settings
        function renderCategoryList() {
            const listEl = document.getElementById('categoryList');
            if (state.categories.length === 0) {
                listEl.innerHTML = '<div class="empty-categories">カテゴリがありません</div>';
                return;
            }
            listEl.innerHTML = state.categories.map(cat => `
                <div class="category-item">
                    <span class="category-name">${cat}</span>
                    <button class="category-delete-btn" onclick="deleteCategory('${cat}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        // Update undo button state
        function updateUndoButton() {
            const btn = document.getElementById('undoBtn');
            btn.disabled = state.history.length === 0;
        }

        // Quick pay from home
        function quickPay(amount) {
            const category = document.getElementById('homeCategorySelect').value;
            recordExpenseWithAmount(amount, category);
        }

        // Category quick pay
        function categoryQuickPay(category, amount) {
            recordExpenseWithAmount(amount, category);
        }

        // Home record expense
        function homeRecordExpense() {
            const amount = parseInt(document.getElementById('homeAmountInput').value) || 0;
            const category = document.getElementById('homeCategorySelect').value;

            if (amount <= 0) {
                showToast('金額を入力してください');
                return;
            }

            recordExpenseWithAmount(amount, category);
            document.getElementById('homeAmountInput').value = '';
        }

        // Record expense with amount
        function recordExpenseWithAmount(amount, category) {
            const now = new Date();
            const date = `${now.getMonth() + 1}/${now.getDate()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

            const expense = {
                date,
                category,
                amount,
                timestamp: now.toISOString()
            };

            state.history.push(expense);
            lastExpense = expense;

            state.spent += amount;
            state.balance = state.budget - state.spent;

            saveState();
            renderAll();
            showToast(`¥${amount.toLocaleString()} を記録しました`);
        }

        // Record expense from category tab
        function recordExpense(category) {
            const amountInput = document.getElementById('amount-' + category);
            const amount = parseInt(amountInput.value) || 0;

            if (amount <= 0) {
                showToast('金額を入力してください');
                return;
            }

            recordExpenseWithAmount(amount, category);
            amountInput.value = '';
        }

        // Undo last expense
        function undoLastExpense() {
            if (state.history.length === 0) return;

            const last = state.history.pop();
            state.spent -= last.amount;
            state.balance = state.budget - state.spent;

            saveState();
            renderAll();
            showToast(`¥${last.amount.toLocaleString()} を取消しました`);
        }

        // Set budget
        function setBudget() {
            const budget = parseInt(document.getElementById('budgetInput').value) || 0;
            if (budget <= 0) {
                showToast('予算を入力してください');
                return;
            }
            state.budget = budget;
            state.balance = budget - state.spent;
            saveState();
            renderAll();
            document.getElementById('budgetInput').value = '';
            closeSettings();
            showToast(`予算を ¥${budget.toLocaleString()} に設定しました`);
        }

        // Add category
        function addCategory() {
            const input = document.getElementById('newCategoryInput');
            const categoryName = input.value.trim();
            if (!categoryName) {
                showToast('カテゴリ名を入力してください');
                return;
            }
            if (state.categories.includes(categoryName)) {
                showToast('このカテゴリは既に存在します');
                return;
            }
            state.categories.push(categoryName);
            saveState();
            renderAll();
            input.value = '';
            showToast(`「${categoryName}」を追加しました`);
        }

        // Delete category
        function deleteCategory(categoryName) {
            if (!confirm(`「${categoryName}」を削除しますか？`)) return;
            state.categories = state.categories.filter(c => c !== categoryName);
            if (currentTab === categoryName) currentTab = 'home';
            saveState();
            renderAll();
            showToast(`「${categoryName}」を削除しました`);
        }

        // Clear category history
        function clearCategoryHistory(category) {
            if (!confirm(`「${category}」の履歴をすべて削除しますか？`)) return;
            const removedAmount = state.history.filter(h => h.category === category).reduce((sum, h) => sum + h.amount, 0);
            state.history = state.history.filter(h => h.category !== category);
            state.spent -= removedAmount;
            state.balance = state.budget - state.spent;
            saveState();
            renderAll();
            showToast('履歴をクリアしました');
        }

        // Clear all history
        function clearAllHistory() {
            if (!confirm('すべての履歴を削除しますか？')) return;
            state.history = [];
            state.spent = 0;
            state.balance = state.budget;
            saveState();
            renderAll();
            showToast('すべての履歴をクリアしました');
        }

        // Reset all data
        function resetAll() {
            if (!confirm('すべてのデータをリセットしますか？この操作は元に戻せません。')) return;
            state = { budget: 0, balance: 0, spent: 0, history: [], categories: [] };
            currentTab = 'home';
            saveState();
            renderAll();
            closeSettings();
            showToast('データをリセットしました');
        }

        // Export data
        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `limit-keeper-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('データをエクスポートしました');
        }

        // Import data
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importedState = JSON.parse(e.target.result);
                    if (importedState.budget !== undefined && importedState.history !== undefined) {
                        state = importedState;
                        saveState();
                        renderAll();
                        showToast('データをインポートしました');
                    } else {
                        showToast('無効なファイル形式です');
                    }
                } catch (err) {
                    showToast('ファイルの読み込みに失敗しました');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Settings modal controls
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        document.getElementById('settingsModal').addEventListener('click', function (e) {
            if (e.target === this) closeSettings();
        });

        // Enter key support
        document.getElementById('homeAmountInput').addEventListener('keypress', e => { if (e.key === 'Enter') homeRecordExpense(); });
        document.getElementById('budgetInput').addEventListener('keypress', e => { if (e.key === 'Enter') setBudget(); });
        document.getElementById('newCategoryInput').addEventListener('keypress', e => { if (e.key === 'Enter') addCategory(); });

        // Initialize app
        init();
    </script>
</body>

</html>